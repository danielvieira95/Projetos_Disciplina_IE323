from machine import Pin, I2C, ADC, Timer
from ssd1306 import SSD1306_I2C
import framebuf
import neopixel
import utime

WIDTH = 128  # Largura do display oLED
HEIGHT = 64  # Altura do display oLED

# Modos de funcionamento do programa
NO_MODE = 0
MODE_DELAY = 1
MODE_TIMER = 2

pressed_button_counter = 0
button_a_state = 0
button_b_state = 0
led_state = 0
loop_counter = 0
mode_selected = 0

# Configuração do display oLED
i2c = I2C(1, scl=Pin(15), sda=Pin(14), freq=400000)
oled = SSD1306_I2C(WIDTH, HEIGHT, i2c)

# Apaga todo o display
oled.fill(0)
oled.show()

# Salva os arrays de bytes com as imagens que serão exibidas no display oLED futuramente
sleeping_snoopy = bytearray(b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xf1\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xe0\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xe0\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xbe\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\x7f\x7f\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xfe\xff\xbf\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xdf\xff\xff\xe6\xff\xff\xff\xc0\xff\xff\xff\xff\xdf\xff\xff\xcf\x7f\xff\xff\xc0\xff\xff\xff\xff\xdf\xff\xff\xcf\x7f\xff\xff\xc0\xff\xff\xff\xff\xdf\xf8\x8f\xed\xff\xff\xff\xc0\xff\xff\xfe\xff\xdf\xef\xfb\xef\xff\xff\xff\xc0\xff\xff\xfe\xff\xdf\xbf\xfd\xef\xff\xff\xff\xc0\xff\xff\xfd\xff\xde\xff\xfe\xcf\xff\xff\xff\xc0\xff\xff\xfd\xdf\xfd\xff\xff\x5f\xff\xff\xff\xc0\xff\xff\xff\xff\xf3\xff\xff\xb7\xff\xff\xff\xc0\xff\xff\xff\xff\xf3\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfb\xff\xff\xff\x7f\xff\xff\xc0\xff\xff\xfd\xff\xfb\xe3\x3f\xff\x7f\xff\xff\xc0\xff\xff\xfd\xff\xf3\xff\xdf\xc0\x3f\xff\xff\xc0\xff\xff\xfe\xfe\x1c\x1f\xef\xff\xbf\xff\xff\xc0\xff\xff\xfc\x00\x7f\xf7\xef\xff\xff\xff\xff\xc0\xff\xff\xfb\xfc\x7f\xfc\xcf\xff\xff\xff\xff\xc0\xff\xff\xfb\xfc\x7f\xff\x1f\xff\xdf\xff\xff\xc0\xff\xff\xfb\xfc\x7f\xff\xff\xff\xdf\xff\xff\xc0\xff\xff\xfb\xfc\x3f\xff\xf8\x01\xdf\xff\xff\xc0\xff\xff\xfb\xfc\x3c\x20\x07\xff\xef\xff\xff\xc0\xff\xff\xfe\x0c\x27\xff\xff\xff\xef\xff\xff\xc0\xff\xff\xf7\xfc\x3f\xff\xff\xff\xef\xff\xff\xc0\xff\xff\xf7\xfc\x3f\xff\xff\xff\xf7\xff\xff\xc0\xff\xff\xf7\xfe\x3f\xff\xff\xff\xf7\xff\xff\xc0\xff\xff\xf7\xff\x7f\xff\xff\xff\xfb\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xfb\xff\xff\xc0\xff\xff\xef\xff\xff\xff\xff\xe3\xff\xff\xff\xc0\xff\xff\xef\x00\x70\x00\x00\x3e\x0d\xff\xff\xc0\xff\xff\xef\xff\xff\xff\xff\xff\xfe\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0') 
awaken_snoopy = bytearray(b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\x9f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\x80\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xf0\x00\x7f\x3f\xff\xff\xff\xc0\xff\xff\xff\xff\xcf\xff\xff\x9f\xff\xff\xff\xc0\xff\xff\xff\xff\xbf\xff\xff\xdf\xff\xff\xff\xc0\xff\xff\xff\xff\x3f\xff\xff\xef\xff\xff\xff\xc0\xff\xff\xff\xff\x7f\xff\xff\xef\xff\xff\xff\xc0\xff\xff\xff\xf0\xff\xfb\xff\xf7\xff\xff\xff\xc0\xff\xff\xff\xee\xff\xfb\xff\xf7\xff\xff\xff\xc0\xff\xff\xff\xe8\xff\xff\xff\xf7\xff\xff\xff\xc0\xff\xff\xff\xe0\xff\xff\xff\x8b\xff\xff\xff\xc0\xff\xff\xff\xf0\xff\xff\xfd\x03\xff\xff\xff\xc0\xff\xff\xff\xff\x7f\xff\xf8\x0b\xff\xff\xff\xc0\xff\xff\xff\xff\x9f\xff\xf8\x0b\xff\xff\xff\xc0\xff\xff\xff\xff\xe7\xff\xf0\x0b\xff\xff\xff\xc0\xff\xff\xff\xff\xf8\xff\xf0\x17\xff\xff\xff\xc0\xff\xff\xff\xff\xff\x3f\xf0\x07\xff\xff\xff\xc0\xff\xff\xff\xff\xff\x9f\xf0\x0f\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xef\x84\x1f\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xef\x78\x7f\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xee\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xc1\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\x9c\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\x3d\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\x7e\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfe\xfe\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfc\xfe\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfd\xfe\x7f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfd\xee\x7f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfb\xee\x7f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfb\xec\x7f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xf9\xe0\x3f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfe\x7a\x2f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xbe\xdf\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xbe\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xf0\x36\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xdf\xf6\x7f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xb9\xef\xbf\xff\xff\xff\xff\xc0\xff\xff\xff\xff\x83\xff\xdf\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xf6\xbf\xdf\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xfc\x00\x3f\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc0')
awakening_snoopy = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x00\x3f\xe0\x00\x00\x00\x00\x00\x00\x00\x7f\xf0\x00\x00\x00\x00\x00\x00\x00\xff\xfe\x1f\xf0\x00\x00\x00\x00\x01\xff\xff\xff\xfc\x00\x00\x00\x00\x01\xff\xff\xff\xfe\x00\x00\x00\x00\x03\xff\xdd\xff\xff\x00\x00\x00\x00\x03\xff\x9d\xff\xff\x80\x00\x00\x00\x07\xff\xff\xff\xff\xc0\x00\x00\x00\x07\xff\xff\xfe\x0f\xe0\x00\x00\x00\x0f\xff\xff\xfe\x0f\xe0\x00\x00\x00\x0a\xff\xff\xff\xff\xe0\x00\x00\x00\x08\x7f\xff\xff\xff\xe0\x00\x00\x00\x08\x3f\xff\xff\xff\xe0\x00\x00\x00\x08\x3f\xff\xff\xff\xc0\x00\x00\x00\x18\x17\xff\xff\xff\x80\x00\x00\x00\x18\x1f\xff\xff\xf8\x00\x00\x00\x00\x08\x1b\xff\xff\x00\x00\x00\xc0\x00\x08\x1b\xff\xde\x03\xf0\x03\xc0\x00\x0c\x0c\x01\xfe\x0f\xfc\x0f\xe0\x00\x04\x08\x00\x7c\xff\xff\x07\xe0\x00\x04\x18\x00\x1b\xff\xff\x07\xe0\x00\x02\x18\x00\x07\xff\xff\x87\xe0\x00\x00\x40\x00\x07\xff\xff\x87\xf0\x00\x00\x00\x00\x07\xff\xff\xcb\xf0\x00\x00\x00\x00\x0f\xff\xff\xc3\xf0\x00\x00\x00\x00\x0f\xff\xff\xc1\xf0\x00\x00\x00\x00\x3f\xfc\x7f\xfd\xf8\x00\x00\x00\x00\x7f\xff\xbf\xff\xf8\x00\x00\x00\x00\xff\xff\xdf\xff\xf8\x00\x00\x00\x00\xfc\x9f\xdf\xff\xf8\x00\x1f\xff\xff\xff\xcf\xbf\xff\xe3\xc0\x1f\xff\xff\xff\xff\xff\xff\xff\xc0\x1f\xff\xff\xff\xff\xff\xff\xff\xe0\x3f\xff\xff\xff\xff\xff\xff\xff\xe0\x3f\xff\xff\xff\xff\xff\xff\xff\xe0\x3f\xff\xff\xff\xff\xff\xff\xff\xe0\x3f\xff\xff\xff\xff\xff\xff\xff\xe0\x3f\xff\xff\xff\xff\xff\xff\xff\xf0\x7f\xff\xff\xff\xff\xff\xff\xff\xf0\x7f\xff\xff\xff\xff\xff\xff\xff\xf0\x7f\xff\xff\xff\xff\xff\xff\xff\xf0\x7f\x00\x3f\xff\xff\xff\xff\xff\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00')

# Configuração dos botões A e B
button_a = Pin(5, Pin.IN, Pin.PULL_UP)
button_b = Pin(6, Pin.IN, Pin.PULL_UP)

# Configuração da matriz de LEDs
np = neopixel.NeoPixel(Pin(7), 25)

# Inicializa a matriz com todos os LEDs apagados
for i in range(25):
    np[i] = (0, 0, 0)
np.write()

# Configuração do joystick
adc_x = ADC(Pin(27))

# Define os valores mínimos e máximos dos conversores AD do joystick e também o valor médio
adc_min = 176
adc_max = 65263
adc_mean_x = ((adc_max - adc_min)/2)

# Define um limiar para determinar uma mudança significativa do joystick
threshold = 1000

# Configuração do timer
temporizador = Timer()

def check_button_a():
    global button_a, pressed_button_counter, button_a_state
    if (button_a.value() == 0) & (button_a_state == 0):
        pressed_button_counter += 1
        button_a_state = 1
    elif (button_a.value() == 1) & (button_a_state == 1):
        button_a_state = 0

def check_button_b():
    global button_b, pressed_button_counter, button_b_state
    if (button_b.value() == 0) & (button_b_state == 0):
        pressed_button_counter += 1
        button_b_state = 1
    elif (button_b.value() == 1) & (button_b_state == 1):
        button_b_state = 0
    
def display_update(snoopy):
    global pressed_button_counter
    oled.fill(0)
    oled.text("Contador: " + str(pressed_button_counter), 22, 3)
    if (snoopy == awakening_snoopy):
        fbuf_snoopy = framebuf.FrameBuffer(snoopy, 70, 45, framebuf.MONO_HLSB) # Objeto que contém a imagem formada pelos bytes que vão compor a imagem, com altura e largura definidos
        oled.blit(fbuf_snoopy, 32, 18) # Imagem vai aparecer em x = 22 e y = 18        
    else:    
        fbuf_snoopy = framebuf.FrameBuffer(snoopy, 90, 45, framebuf.MONO_HLSB) # Objeto que contém a imagem formada pelos bytes que vão compor a imagem, com altura e largura definidos
        oled.blit(fbuf_snoopy, 22, 18) # Imagem vai aparecer em x = 22 e y = 18
    oled.show()
    utime.sleep_us(1)

def blink_on():
    global led_state
    for i in range(25):
        np[i] = (5, 0, 0)
    np.write()
    led_state = 1

def blink_off():
    global led_state
    for i in range(25):
        np[i] = (0, 0, 0)
    np.write()
    led_state = 0

def toggle_led():
    global led_state
    if (led_state == 0):
        blink_on()
    else:
        blink_off()

def callback_temporizador(timer):
    global loop_counter
    toggle_led()
    loop_counter += 1

def select_mode():
    # Tela de início
    global mode_selected, NO_MODE, MODE_DELAY, MODE_TIMER
    oled.fill(0)
    oled.text("Escolha um modo:", 0, 10)
    oled.text("Delay <---", 0, 30)
    oled.text("---> Timer ", 50, 50)
    oled.show()
    while (mode_selected == NO_MODE):
        adc_value_x = adc_x.read_u16()
        if (adc_value_x > (adc_mean_x + threshold)):
            mode_selected = MODE_DELAY
            oled.fill(0)
            oled.text("Modo delay", 0, 30)
            oled.show()
            utime.sleep(3)
        elif (adc_value_x < (adc_mean_x - threshold)):
            mode_selected = MODE_TIMER
            oled.fill(0)
            oled.text("Modo timer", 0, 30)
            oled.show()
            utime.sleep(3)

while True:
    select_mode()
    if (mode_selected == MODE_DELAY):
        blink_off()
        loop_counter = 0
        for loop_counter in range(10):
            check_button_a()
            check_button_b()
            button_a_state = 0
            button_b_state = 0
            display_update(sleeping_snoopy)
            toggle_led()
            utime.sleep(3)
            loop_counter += 1
        pressed_button_counter = 0
        mode_selected = NO_MODE
    elif (mode_selected == MODE_TIMER):
        blink_off()
        temporizador.init(period = 3000, mode = Timer.PERIODIC, callback = callback_temporizador)
        loop_counter = 0
        while(loop_counter < 10):
            check_button_a()
            check_button_b()
            display_update(awaken_snoopy)
        temporizador.deinit()
        pressed_button_counter = 0
        mode_selected = NO_MODE